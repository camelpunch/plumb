#!/usr/bin/env ruby

require_relative '../lib/plumb/infrastructure/queue'
require_relative '../lib/plumb/infrastructure/queue_runner'

module Plumb
  module WaitingQueueRunner
    class << self
      def call
        waiting = Infrastructure::Queue.new('pipeline-waiting-queue')
        immediate = Infrastructure::Queue.new('pipeline-immediate-queue')
        runner = Infrastructure::QueueRunner.new(
          waiting,
          ->{ sleep 1 }
        )

        waiting.clear
        immediate.clear

        loop do
          runner.run do |job|
            puts "popped from waiting"
            immediate << job
          end
        end
      end
    end
  end
end
Plumb::WaitingQueueRunner.call
