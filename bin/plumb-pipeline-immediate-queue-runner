#!/usr/bin/env ruby

require 'json'
require 'tmpdir'
require_relative '../lib/plumb'
require_relative '../lib/plumb/queued_jobs'
require_relative '../lib/plumb/git_repository'
require_relative '../lib/plumb/web_reporter'
require_relative '../lib/plumb/factories/queue_factory'

module Plumb
  module ImmediateQueueRunner
    class << self
      def call
        config = JSON.parse(File.read(ARGV[0]))
        factory = QueueFactory.new(config)
        jobs = QueuedJobs.new(factory.immediate_queue, ->{ sleep 1 })

        Dir.mktmpdir do |projects_dir|
          repo = GitRepository.new(projects_dir)
          reporter = WebReporter.new(config.fetch('build_status_endpoint'))

          loop do
            jobs.pop do |job|
              Build.new(job, repo, reporter).run
            end
          end
        end
      end
    end
  end
end
Plumb::ImmediateQueueRunner.call

